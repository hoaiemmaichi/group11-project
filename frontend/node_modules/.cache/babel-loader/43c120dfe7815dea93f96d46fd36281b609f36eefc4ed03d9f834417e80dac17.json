{"ast":null,"code":"import axios from'axios';const API=process.env.REACT_APP_API_URL||'http://localhost:3000';// Theo d√µi tr·∫°ng th√°i refresh token ƒë·ªÉ tr√°nh g·ªçi nhi·ªÅu l·∫ßn\nlet isRefreshing=false;let refreshSubscribers=[];// Th√™m subscriber v√†o h√†ng ƒë·ª£i\nfunction subscribeTokenRefresh(callback){refreshSubscribers.push(callback);}// Th·ª±c thi t·∫•t c·∫£ callback trong h√†ng ƒë·ª£i v·ªõi token m·ªõi\nfunction onRefreshed(token){refreshSubscribers.forEach(callback=>callback(token));refreshSubscribers=[];}// H√†m refresh token\nasync function refreshAuthToken(){try{console.log('üîÑ B·∫Øt ƒë·∫ßu refresh token...');const refreshToken=localStorage.getItem('refreshToken');if(!refreshToken){console.log('‚ùå Kh√¥ng t√¨m th·∫•y refresh token trong localStorage');throw new Error('No refresh token available');}console.log(\"\\uD83D\\uDCE4 G\\u1EEDi refresh token c\\u0169: \".concat(refreshToken.substring(0,10),\"...\"));const response=await axios.post(\"\".concat(API,\"/auth/refresh\"),{refreshToken});const{token:newAccessToken,refreshToken:newRefreshToken}=response.data;console.log('‚úÖ Nh·∫≠n token m·ªõi t·ª´ server');// L∆∞u tokens m·ªõi\nlocalStorage.setItem('token',newAccessToken);if(newRefreshToken){localStorage.setItem('refreshToken',newRefreshToken);console.log(\"\\uD83D\\uDCE5 \\u0110\\xE3 l\\u01B0u refresh token m\\u1EDBi: \".concat(newRefreshToken.substring(0,10),\"...\"));}console.log('‚úÖ Ho√†n t·∫•t refresh token');return newAccessToken;}catch(error){// X√≥a h·∫øt tokens n·∫øu refresh th·∫•t b·∫°i\nlocalStorage.removeItem('token');localStorage.removeItem('refreshToken');localStorage.removeItem('currentUser');throw error;}}// Request interceptor: th√™m Authorization header t·ª´ localStorage\naxios.interceptors.request.use(config=>{try{var _config$headers;const token=localStorage.getItem('token');if(token&&!((_config$headers=config.headers)!==null&&_config$headers!==void 0&&_config$headers.Authorization)){config.headers=config.headers||{};config.headers.Authorization=\"Bearer \".concat(token);}}catch(e){}return config;},error=>Promise.reject(error));// Response interceptor: x·ª≠ l√Ω 401 v√† refresh token\naxios.interceptors.response.use(response=>response,async error=>{const originalRequest=error.config;// N·∫øu kh√¥ng ph·∫£i l·ªói 401 ho·∫∑c ƒë√£ th·ª≠ refresh r·ªìi, reject lu√¥n\nif(!error.response||error.response.status!==401||originalRequest._retry){return Promise.reject(error);}originalRequest._retry=true;// N·∫øu ƒëang refresh token r·ªìi th√¨ ƒë·ª£i k·∫øt qu·∫£\nif(isRefreshing){try{const token=await new Promise((resolve,reject)=>{subscribeTokenRefresh(token=>{if(token)resolve(token);else reject(new Error('Failed to refresh token'));});});originalRequest.headers['Authorization']=\"Bearer \".concat(token);return axios(originalRequest);}catch(err){window.location.href='/login';return Promise.reject(err);}}// B·∫Øt ƒë·∫ßu refresh token\nisRefreshing=true;try{const newToken=await refreshAuthToken();originalRequest.headers['Authorization']=\"Bearer \".concat(newToken);onRefreshed(newToken);isRefreshing=false;return axios(originalRequest);}catch(refreshError){isRefreshing=false;onRefreshed(null);// Chuy·ªÉn v·ªÅ trang login n·∫øu refresh th·∫•t b·∫°i\nwindow.location.href='/login';return Promise.reject(refreshError);}});export default axios;","map":{"version":3,"names":["axios","API","process","env","REACT_APP_API_URL","isRefreshing","refreshSubscribers","subscribeTokenRefresh","callback","push","onRefreshed","token","forEach","refreshAuthToken","console","log","refreshToken","localStorage","getItem","Error","concat","substring","response","post","newAccessToken","newRefreshToken","data","setItem","error","removeItem","interceptors","request","use","config","_config$headers","headers","Authorization","e","Promise","reject","originalRequest","status","_retry","resolve","err","window","location","href","newToken","refreshError"],"sources":["d:/PM MNM/group11-project1/frontend/src/api.js"],"sourcesContent":["import axios from 'axios';\n\nconst API = process.env.REACT_APP_API_URL || 'http://localhost:3000';\n\n// Theo d√µi tr·∫°ng th√°i refresh token ƒë·ªÉ tr√°nh g·ªçi nhi·ªÅu l·∫ßn\nlet isRefreshing = false;\nlet refreshSubscribers = [];\n\n// Th√™m subscriber v√†o h√†ng ƒë·ª£i\nfunction subscribeTokenRefresh(callback) {\n  refreshSubscribers.push(callback);\n}\n\n// Th·ª±c thi t·∫•t c·∫£ callback trong h√†ng ƒë·ª£i v·ªõi token m·ªõi\nfunction onRefreshed(token) {\n  refreshSubscribers.forEach(callback => callback(token));\n  refreshSubscribers = [];\n}\n\n// H√†m refresh token\nasync function refreshAuthToken() {\n  try {\n    console.log('üîÑ B·∫Øt ƒë·∫ßu refresh token...');\n    const refreshToken = localStorage.getItem('refreshToken');\n    if (!refreshToken) {\n      console.log('‚ùå Kh√¥ng t√¨m th·∫•y refresh token trong localStorage');\n      throw new Error('No refresh token available');\n    }\n    console.log(`üì§ G·ª≠i refresh token c≈©: ${refreshToken.substring(0, 10)}...`);\n\n    const response = await axios.post(`${API}/auth/refresh`, { refreshToken });\n    const { token: newAccessToken, refreshToken: newRefreshToken } = response.data;\n    console.log('‚úÖ Nh·∫≠n token m·ªõi t·ª´ server');\n\n    // L∆∞u tokens m·ªõi\n    localStorage.setItem('token', newAccessToken);\n    if (newRefreshToken) {\n      localStorage.setItem('refreshToken', newRefreshToken);\n      console.log(`üì• ƒê√£ l∆∞u refresh token m·ªõi: ${newRefreshToken.substring(0, 10)}...`);\n    }\n    console.log('‚úÖ Ho√†n t·∫•t refresh token');\n\n    return newAccessToken;\n  } catch (error) {\n    // X√≥a h·∫øt tokens n·∫øu refresh th·∫•t b·∫°i\n    localStorage.removeItem('token');\n    localStorage.removeItem('refreshToken');\n    localStorage.removeItem('currentUser');\n    throw error;\n  }\n}\n\n// Request interceptor: th√™m Authorization header t·ª´ localStorage\naxios.interceptors.request.use((config) => {\n  try {\n    const token = localStorage.getItem('token');\n    if (token && !config.headers?.Authorization) {\n      config.headers = config.headers || {};\n      config.headers.Authorization = `Bearer ${token}`;\n    }\n  } catch (e) {}\n  return config;\n}, (error) => Promise.reject(error));\n\n// Response interceptor: x·ª≠ l√Ω 401 v√† refresh token\naxios.interceptors.response.use(\n  response => response,\n  async error => {\n    const originalRequest = error.config;\n    \n    // N·∫øu kh√¥ng ph·∫£i l·ªói 401 ho·∫∑c ƒë√£ th·ª≠ refresh r·ªìi, reject lu√¥n\n    if (!error.response || error.response.status !== 401 || originalRequest._retry) {\n      return Promise.reject(error);\n    }\n\n    originalRequest._retry = true;\n\n    // N·∫øu ƒëang refresh token r·ªìi th√¨ ƒë·ª£i k·∫øt qu·∫£\n    if (isRefreshing) {\n      try {\n        const token = await new Promise((resolve, reject) => {\n          subscribeTokenRefresh(token => {\n            if (token) resolve(token);\n            else reject(new Error('Failed to refresh token'));\n          });\n        });\n        \n        originalRequest.headers['Authorization'] = `Bearer ${token}`;\n        return axios(originalRequest);\n      } catch (err) {\n        window.location.href = '/login';\n        return Promise.reject(err);\n      }\n    }\n\n    // B·∫Øt ƒë·∫ßu refresh token\n    isRefreshing = true;\n\n    try {\n      const newToken = await refreshAuthToken();\n      originalRequest.headers['Authorization'] = `Bearer ${newToken}`;\n      onRefreshed(newToken);\n      isRefreshing = false;\n      return axios(originalRequest);\n    } catch (refreshError) {\n      isRefreshing = false;\n      onRefreshed(null);\n      // Chuy·ªÉn v·ªÅ trang login n·∫øu refresh th·∫•t b·∫°i\n      window.location.href = '/login';\n      return Promise.reject(refreshError);\n    }\n  }\n);\n\nexport default axios;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}